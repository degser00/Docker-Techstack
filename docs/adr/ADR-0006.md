# ADR-0006: Observability Stack (Modular Deployment)

**Date:** 2025-11-09  
**Status:** Accepted  
**Deciders:** Owner  
**Relates:** References ADR-0002 (separation of duties & compliance), Notes Proxy placement

---

## Context

We need self-hosted observability to quantify system health, usage, and operational KPIs across n8n, the **AI Proxy**, Ollama/OpenWebUI, and other services—**without** exposing AI content. We want modular deployment, zero-trust ingress, and clear blast-radius boundaries.

The **Proxy** (defined in ADR-0002’s workflow) is a **separate service** that sits **between n8n and Ollama/OpenWebUI** and writes compliance logs. Observability must consume only **metrics/logs** from the Proxy—not content.

---

## Decision

Adopt a **modular observability stack** comprised of:
- **Prometheus** — metrics TSDB & scrape engine  
- **Loki** — central log store  
- **Promtail** — Docker log shipper  
- **cAdvisor** — container metrics  
- **Grafana (OSS)** — dashboards & alerts

### Deployment split (compose projects)

> These are **observability-only** compose projects. The **Proxy** is **standalone** in `/modules/proxy` (not part of Observability), but is monitored by Observability.

1. **Observability Core** — `/modules/observability/core`  
   Services: `prometheus`, `loki`, `promtail`, `cadvisor`, *(optional)* `pushgateway`.

2. **Grafana** — `/modules/observability/grafana`  
   Service: `grafana` only.

3. **Ingress (Cloudflare)** — `/modules/ingress/cloudflared-grafana`  
   Service: `cloudflared` tunnel for Grafana.

### Related service (not part of this compose)

- **Proxy** — `/modules/proxy`  
  Purpose: sits **between n8n and Ollama/OpenWebUI** (`n8n → Proxy → Ollama/OpenWebUI`); writes compliance logs; exports **Prometheus metrics** (tokens, latency, error rate). Observability scrapes these metrics and collects its logs.

### Networks

- `obs-net` (internal): shared by core, grafana, cloudflared; **no host ports** required.  
- `internal-ai`: n8n, Proxy, Ollama/OpenWebUI (app traffic).  
- `postgres-net`: Proxy ↔ Compliance DB, NocoDB.  
- Existing stacks may either join `obs-net` for scraping or expose a local metrics port consumed via host routing.

### Scope & Boundaries

- Observability ingests **container logs** and **metrics**, including Proxy token/latency/error metrics.  
- **No raw AI content** is ingested (see ADR-0002).  
- DB access limited to **read-only metrics/summary views** using the **`obs_ro`** role.

### Security

- Only **Grafana** is exposed via **Cloudflare Zero Trust**.  
- Component credentials stored via env/secrets; rotate per playbook.  
- Grafana roles: **Admin** (Owner), **Editor** (operators), **Viewer** (read-only).

### Data Retention

- Prometheus retention: **180 days** (configurable).  
- Loki retention: **90 days** (configurable).  
- Compliance data retention remains in ADR-0002 (maintenance job).

### Alerting (baseline)

- Node/container down; scrape failures  
- High CPU/RAM; disk pressure  
- n8n workflow **error rate spike**  
- Proxy **error rate** or **latency SLO** breach

### Alternatives Considered

- All-in-one SaaS observability → **Rejected** (cost, data control).  
- Single-compose monolith → **Rejected** (blast radius, upgrade friction).

### Consequences

- ✅ Clear isolation; safer upgrades; Zero-Trust exposure only for Grafana  
- ✅ Works with ADR-0002 boundaries; no content leakage  
- ⚠️ Multiple compose projects to manage (mitigated by runbooks)  
- ⚠️ Prometheus/Loki sizing/retention tuning required over time

---

## Rollout Plan

1. Create `obs-net` and deploy **Observability Core**.  
2. Deploy **Grafana**; add Prometheus & Loki as data sources.  
3. Deploy **cloudflared** for Grafana; enforce Zero Trust policy.  
4. Deploy **Proxy** (standalone) per ADR-0002; expose `/metrics`.  
5. Connect **n8n** and **Proxy** metrics/logs; validate dashboards & alerts.  
6. Document credentials, URLs, and runbooks.

---

## Documentation Layout

- `/docs/adr/ADR-0002.md` — append sections: *Observability Interface*, *Ingress & Exposure*, *Proxy Placement*.  
- `/docs/adr/ADR-0006.md` — this ADR.  
- `/docs/runbooks/observability/`  
  - `bootstrapping.md` — compose up/down, backups, upgrades  
  - `alerts.md` — alert meanings & actions  
  - `dashboards.md` — dashboard IDs, panels, ownership  
- `/docs/security/zero-trust.md` — Cloudflare policy for Grafana  
- `/modules/observability/...` — the three observability compose projects & configs  
- `/modules/proxy/...` — standalone Proxy compose and configuration
